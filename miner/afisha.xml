<?xml version="1.0" encoding="UTF-8"?>

<config scriptlang="default_script_lang">

<var-def name="site">
	http://www.afisha.ru
</var-def>

<!-- biuld continent list -->
<var-def name="continentList">
	<xpath expression="//div[@class='b-geonav']/a/@href">
		<html-to-xml>
			<http url="http://www.afisha.ru/travel/"/>
		</html-to-xml>
	</xpath>
</var-def>
<var-def name="blank"></var-def>

<!-- begin cycle by continents -->
<loop item="continent" index="i" empty="yes">
	<list>
		<var name="continentList"/>
	</list>
	<body>
	<empty>
		<var-def name="continentPage">
			<html-to-xml>
				<http url="${sys.fullUrl(continent, blank);}"/>
			</html-to-xml>				
		</var-def>
		
		<!-- biuld list of countries in "i" continent -->
		<var-def name="countryList">
			<xpath expression="//div[@class='b-geonav']/a/@href">
				<var name="continentPage"/>
			</xpath>
		</var-def>
		
		<!-- begin cycle by countries in "i" continent -->
			<loop item="country" index="k" empty="yes">
				<list>
					<var name="countryList"/>
				</list>
				<body>
				<empty>
					<var-def name="countryPage">
						<html-to-xml>
							<http url="${sys.fullUrl(country, blank);}"/>
						</html-to-xml>									
					</var-def>
					
					<!--biuld list by cities in "k" country in "i" continent-->
					<var-def name="cityList">
						<xpath expression="//div[@class='b-geonav']/a/@href">
							<var name="countryPage"/>
						</xpath>
					</var-def>
					
					<!-- begin cycle by cities in "k" country in "i" continent -->
					<loop item="city" index="l" empty="yes">
						<list>
							<var name="cityList"/>
						</list>
						<body>
						<empty>
						<try>
							<body>
							<!-- biuld link of pois in "l" city in "k" country in "i" continent -->
							<var-def name="poisLink">
								<xpath expression="//div[@class='b-best-objects']/p/a/@href">
									<html-to-xml>
										<http url='${sys.fullUrl(city, blank);}'></http>
									</html-to-xml>
								</xpath>
							</var-def>
							
							<!-- build real link for the pois list -->
							<script language="javascript">
								<![CDATA[
									var str = city.toString();
									var real = str.substring(str.indexOf("travel/") + 1, str.length());
									real = real.substring(real.indexOf("/") + 1, real.length());
									real = real.substring(real.indexOf("/") + 1, real.length());
									real = "http://www.afisha.ru/" + real + "sights/sight_list/";
								]]>
								sys.defineVariable("realPoisLink", real, true);
							</script>
							<var-def name="poisList">
								<xpath expression="//div[@class='places-list-item']/h3/a/@href">
									<html-to-xml>
										<http url="${sys.fullUrl(realPoisLink, blank);}"></http>
									</html-to-xml>
								</xpath>
							</var-def>
							<loop item="poi" index="m" empty="yes">
								<list>
									<var name="poisList"/>
								</list>
									
								<body>
								<empty>
									<var-def name="poiPage">
										<html-to-xml>
											<http url="${sys.fullUrl(poi, blank);}"></http>
										</html-to-xml>
									</var-def>
									<!-- scrap coordinates-->
									<var-def name="mapPage">
										<xpath expression="//div[@class='g-full-col b-tabs']/ul/li[3]/a/@href">
											<html-to-xml>
												<http url="${sys.fullUrl(poi, blank);}"></http>
											</html-to-xml>
										</xpath>
									</var-def>
									<var-def name="coordinates">
										<xpath expression="//div[@class='g-one-col g-wrapper']/div[@id='map-info']/following-sibling::script[@type='text/javascript']">
											<html-to-xml>
												<http url="${sys.fullUrl(site, mapPage);}"></http>
											</html-to-xml>
										</xpath>
									</var-def>
									<script language="javascript">
										<![CDATA[
											var source = coordinates.toArray();
											var i = 0;
											var coord = new Array();
											while (i < source.length) {
												var j = source[i].toString().indexOf("page_data.map.center");
												if (j >= 0) {
													var str = source[i].toString().substring(j, source[i].toString().length() - 1);
													var jj = str.indexOf("{");
													str = str.substring(jj + 5, str.length());
													var latCoord = str.substring(0, str.indexOf(","));
													str = str.substring(str.indexOf(":"), str.length());
													var lngCoord = str.substring(1, str.indexOf(","));
													coord.push(latCoord.replaceAll(',', '.'));
													coord.push(lngCoord.replaceAll(',', '.'));
												}
												i++;
											}
										]]>
										sys.defineVariable("returnCoordinates", coord.join(";"), true);
									</script>
									<var-def name="realCoords">
										<var name="returnCoordinates"/>
									</var-def>
									<!-- /scrap coordinates-->
									
									<!-- scrap tags -->
									<var-def name="tags">
										<xpath expression="//span[@class='b-tags']/span[@id]">
											<var name="poiPage"/>
										</xpath>
									</var-def>
									<script language="javascript">
										<![CDATA[
											var source = tags.toArray();
											var i = 0;
											var tagsArray = new Array();
											while (i < source.length) {
												var j = source[i].toString().indexOf(">") + 1;
												var str = source[i].toString().substring(j, source[i].toString().length());
												j = str.indexOf("</");
												str = str.substring(0, j);
												tagsArray.push(str);
												i++;
											}
										]]>
										sys.defineVariable("returnTags", tagsArray.join(";"), true);
									</script>
									<var-def name="realTags">
										<var name="returnTags"/>
									</var-def>
									<!-- /scrap tags -->
									
									<!-- scrap usefull info -->
									<var-def name="usefullInfo">
										<xpath expression="//div[@class='b-object-header']/following-sibling::p">
											<var name="poiPage"/>
										</xpath>
									</var-def>
									<!-- /scrap usefull info -->
									
									<!-- scrap descr -->
									<var-def name="descr">
										<xpath expression="//div[@class='b-object-desc']/p[@id]">
											<var name="poiPage"/>
										</xpath>
									</var-def>
									<script language="javascript">
										<![CDATA[
											var source = descr.toArray();
											var i = 0;
											var tagsArray = new Array();
											while (i < source.length) {
												var j = source[i].toString().indexOf(">") + 1;
												var str = source[i].toString().substring(j, source[i].toString().length());
												j = str.indexOf("</");
												str = str.substring(0, j);
												tagsArray.push(str);
												i++;
											}
										]]>
										sys.defineVariable("returnDescr", tagsArray.join(";"), true);
									</script>
									<var-def name="realDescr">
										<var name="returnDescr"/>
									</var-def>
									<!-- /scrap descr -->
									
									<!-- scrap photos -->
									<var-def name="photos">
										<xpath expression="//div[@class='wrimg']/img/@src">
											<var name="poiPage"/>
										</xpath>
									</var-def>
									<script language="javascript">
										<![CDATA[
											var source = photos.toArray();
											var i = 0;
											var photosArray = new Array();
											while (i < source.length) {
												var j = source[i].toString().indexOf("p_s.jpg");
												var str = source[i].toString().substring(0, j);
												str = str + "p_f.jpg";
												photosArray.push(str);
												i++;
											}
										]]>
										sys.defineVariable("returnPhotos", photosArray.join(";"), true);
									</script>
									<var-def name="realPhotos">
										<var name="returnPhotos"/>
									</var-def>
									<!-- /scrap photos -->
								</empty>
								</body>
							</loop>
							</body>
							
							<catch>
							</catch>
						</try>
						</empty>
						</body>
					</loop>
				</empty>
				</body>
			</loop>
	</empty>	
	</body>
</loop>
</config>