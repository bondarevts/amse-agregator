<?xml version="1.0" encoding="UTF-8"?>

<config scriptlang="default_script_lang">


<var-def name="siteName">
	http://www.luxe.ru
</var-def>

<!--Построим список стран-->
<var-def name="countriesList">
	<xpath expression="//a[@class='cohr_' or @class='cohr']/@href">
		<html-to-xml>
<!--			<http url="${linkToScrap}"/>-->
			<http url="www.luxe.ru/countries"/>
		</html-to-xml>
	</xpath>
</var-def>
<!--Закончили строить список стран-->

<!--Цикл по странам-->
<loop item="countryLink" index="j">
	
	<list>
		<var name="countriesList"/>
	</list>

	<body>

		<!--Построим список городов-->
		<var-def name="citar">
			<xpath expression="//div[@style='cursor:pointer;']/following-sibling::div[position() = 1]">
					<var-def name="pageWithCities">
						<html-to-xml outputtype="pretty">
							<http url="${sys.fullUrl(siteName, countryLink);}"/>
<!--							<http url="http://www.luxe.ru/countries/location5.htm"/>-->
			    		</html-to-xml>		
					</var-def>
			</xpath>
		</var-def>
		
		<case>	
			<if condition="${!citar.isEmpty()}">	
			
				<script language="javascript">
					var a = citar.toArray();
					sys.defineVariable("citar",a[0].toString(),true);
				</script>
				
				<var-def name="citar">
					<xpath expression="//div[@class='lslocdiv' or @class='llocdiv']/a/@href">
						<var name="citar"/>
					</xpath>
				</var-def>
				
			</if>
			<else>
			
				<var-def name="citar">
					<xpath expression="//a[count(b)=1]/parent::*/parent::*/preceding-sibling::*//td[count(span)=0]/a[count(b)=0]/@href">
						<var name="pageWithCities"/>
					</xpath>
				</var-def>
				
			</else>
		</case>	
		<!--Закончили строить список городов-->
		
		<loop item="link" index="i" filter="unique">
		
			<list>
				<var name="citar"/>
			</list>
			
			<body>
								
				<var-def name="loadedData">
					<html-to-xml outputtype="pretty">
					    <http url="${sys.fullUrl(siteName, link);}"/>
					</html-to-xml>
				</var-def>
		
				<var-def name="CityName">
					<xpath expression="//td[@style='background: url(/images/tbord.gif) no-repeat left 6px; padding-left:10px;']/*">
						<var name="loadedData"/>
					</xpath>	
				</var-def>
		
		<!--Получить ссылку на страницу с картинками-->
				<var-def name="CityImageLink">
					<xpath expression="//a[@class='more']/@onclick">
						<var name="loadedData"/>
					</xpath>	
				</var-def>
		
				<script language="javascript">
					var a = CityImageLink.toString();
					if( a != ""){
						a = a.substring(a.indexOf("\"")+1 , a.indexOf("\"",a.indexOf("\"")+1));
						sys.defineVariable("CityImageLink","http://www.luxe.ru".concat(a),true);
					}
					else{
						sys.defineVariable("CityImageLink","",true);
					}
				</script>
		
				<var name="CityImageLink"/>
		
				<case>	
		
					<if condition="${!CityImageLink.isEmpty()}">				
						<var-def name="loadedLinkData">
							<xpath expression="//div[@id='picBox']//img/@src">
								<html-to-xml outputtype="pretty">
								  <http url="${CityImageLink}"/>
						  		</html-to-xml>
							 </xpath>
						</var-def>
				
						<script language="javascript">
							<![CDATA[
							var b = "www.luxe.ru";
							var l = loadedLinkData.toArray();
							var i = 0;
							var a = new Array();
							while(i < l.length ){
								a.push(b.concat(l[i].toString().replace("thumbnails","pictures")));
								i++;
							}
						   ]]>
						 	sys.defineVariable("cityImages",a.join(";"),true);
						</script>
					</if>
		
					<else>
						<var-def name="cityImages">
							<xpath expression="//tbody/tr/td/img/@src">
								<var name="loadedData"/>
							</xpath>
						</var-def>
					</else>	
				</case>
				<!--Тут заканчиваеться выдерание картинок-->
		
				<var-def name="cityDescription">
					<xpath expression="//div[@class='info_content']">
						<var name="loadedData"/>
					</xpath>	
				</var-def>
		
				<script>
					<![CDATA[
					var description = cityDescription.toString();
					if(!description.isEmpty()){
						description = 	description.substring(0,description.indexOf("</div>"));
						var hasAtractions = description.indexOf("ОСНОВНЫЕ ДОСТОПРИМЕЧАТЕЛЬНОСТИ:");
						if(hasAtractions != -1){
							var atr = description.substring(hasAtractions + "ОСНОВНЫЕ ДОСТОПРИМЕЧАТЕЛЬНОСТИ:".length());
							description = description.substring(0,hasAtractions);
							sys.defineVariable("cityAtractions",atr, true);
						}
						sys.defineVariable("cityDescription",description,true);
					}
					]]>
				</script>
		
				<var-def name="returnValue">

					<text>type</text>
					<text>City</text>
					
					<text>name</text>
					<template>${CityName.toString()}</template>
					
					<text>photos</text>
					<template>${cityImages.toString()}</template>

					<text>decription</text>
					<template>${cityDescription.toString()}</template>

				</var-def>
						
				<var-def name="addToDB">
					1
				</var-def>
				

			</body>
		</loop>

	</body>
</loop>
</config>
