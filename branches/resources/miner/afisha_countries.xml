<?xml version="1.0" encoding="UTF-8"?>

<config scriptlang="default_script_lang">


<var-def name="site">
	http://www.afisha.ru
</var-def>

<!-- biuld continent list -->
<var-def name="continentList">
	<xpath expression="//div[@class='b-geonav']/a/@href">
		<html-to-xml>
			<http url="http://www.afisha.ru/travel/"/>
		</html-to-xml>
	</xpath>
</var-def>
<var-def name="blank"></var-def>
<!--/ biuld continent list -->


<!-- target: build all cities with their coordinates and description -->
<loop item="continent" index="i" empty="yes" filter="1-8">
	<list>
		<var name="continentList"/>
	</list>
	<body>
	<empty>
		<var-def name="continentPage">
			<html-to-xml>
				<http url="${sys.fullUrl(continent, blank);}"/>
			</html-to-xml>				
		</var-def>
		
		<var-def name="continent_name">
			<xpath expression="//h1[@class='b-main-header']">
				<var name="continentPage"/>
			</xpath>
		</var-def>
		<script language="javascript">
			<![CDATA[
				var source = continent_name.toArray();
				var i = 0;
				var name = new Array();
				while (i < source.length) {
					var j = source[i].toString().indexOf("</span>");
					if (j >= 0) {
						var str = source[i].toString().substring(j + 7, source[i].toString().length());
						var jj = str.indexOf("<");
						str = str.substring(0, jj);
						if (str.equals("Ближний Восток")) {
							str = "Азия";
						} else if (str.equals("Центральная Америка")) {
							str = "Северная Америка";
						}
						name.push(str);
					}
					i++;
				}
			]]>
			sys.defineVariable("returnContinent", name.join(";"), true);
		</script>
		<var-def name="realContinent">
			<var name="returnContinent"/>
		</var-def>
		<!-- biuld list of countries in "i" continent -->
		<var-def name="countryList">
			<xpath expression="//div[@class='b-geonav']/a/@href">
				<var name="continentPage"/>
			</xpath>
		</var-def>
		<!--/ biuld list of countries in "i" continent -->
		
		<!-- begin cycle by countries in "i" continent -->
			<loop item="country" index="k" empty="yes">
				<list>
					<var name="countryList"/>
				</list>
				<body>
				<empty>
					<var-def name="countryPage">
						<html-to-xml>
							<http url="${sys.fullUrl(country, blank);}"/>
						</html-to-xml>									
					</var-def>
					
					<var-def name="country_name">
						<xpath expression="//h1[@class='b-main-header']">
							<var name="countryPage"/>
						</xpath>
					</var-def>
					<script language="javascript">
					<![CDATA[
						var source = country_name.toString();
						var i  = source.indexOf("</span>") + 7;
						var str = source.substring(i, source.length());
						i =  str.indexOf("</span>") + 7;
						str = str.substring(i, str.length());
						str = str.substring(0, str.indexOf("<"));
						var name = new Array();						
						name.push(str);
					]]>
					sys.defineVariable("returnCountry", name.join(";"), true);
					</script>
					<var-def name="realCountry">
						<var name="returnCountry"/>
					</var-def>					
					
					<!-- row country coordinates -->
					<var-def name="country_coords">
						<xpath expression="//script[@type='text/javascript']">
							<var name="countryPage"/>
						</xpath>
					</var-def>
					
					<!-- clean and get real country coordinates -->
					<script language="javascript">
					<![CDATA[ 
						var source = country_coords.toArray();
						var i = 0;
						var coord = new Array();
						while (i < source.length) {
							var str = source[i].toString();
							var j = str.indexOf("page_data.map.center");
							if (j > 0) {
								str = str.substring(j, str.length());
								var k = str.indexOf("lat:");
								str = str.substring(k, str.length());
								k = str.indexOf(", lng:")
								var lat = str.substring(4, k);
								str = str.substring(k + 6, str.length());
								var lng = str.substring(0, str.indexOf(","));
								coord.push(lat.replaceAll(",", "."))
								coord.push(lng.replaceAll(",", "."))
							}
							i++;
						}
					]]>
					sys.defineVariable("returnCountryCoordinates", coord.join(";"), true);
					</script>
					
					<var-def name="realCountryCoordinates">
						<var name="returnCountryCoordinates"/>
					</var-def>
					
					<var-def name="countryDescription">
						<xpath expression="//div[@class='article-item']">
							<var name="countryPage"/>
						</xpath>
					</var-def>
					
					<var-def name="returnValue">
						<text>type</text>
						<template>Country</template>
						
						<text>country_name</text>
						<template>${returnCountry.toString()}</template>
						
						<text>continent_name</text>
						<template>${returnContinent.toString()}</template>
						
						<text>coordinates</text>
						<template>${returnCountryCoordinates.toString()}</template>
						
						<text>description</text>
						<template>${countryDescription.toString()}</template>
					</var-def>
					<var-def name="addToDB">1</var-def>
				</empty>
				</body>
			</loop>
	</empty>
	</body>
</loop>
<!--/ target: build all cities with their coordinates and description -->


</config>